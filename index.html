<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remini-Garden: ê³µê°„ ê¸°ë°˜ íšŒìƒ ì¹˜ìœ  í”Œë«í¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #fcfbf9; color: #2d2a26; }
       .serif { font-family: 'Nanum Myeongjo', serif; }
       
        /* Interactive Elements */
       .step-btn { 
            transition: all 0.2s ease; 
            border-left: 3px solid transparent; 
            text-align: left;
            width: 100%;
        }
       .step-btn:hover { background-color: #4b5563; border-left-color: #6b9080; }
       .step-btn.active { background-color: #374151; border-left-color: #10b981; }

       .nav-arrow {
            transition: transform 0.2s;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.4);
        }
       .nav-arrow:hover { transform: scale(1.1); background: rgba(255,255,255,0.4); }
        
        /* Loading Spinner */
       .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
       .custom-scroll::-webkit-scrollbar { width: 6px; }
       .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
       .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="antialiased">

    <nav class="sticky top-0 z-50 bg-[#fcfbf9]/95 backdrop-blur border-b border-stone-200 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i data-lucide="sprout" class="text-[#6b9080]"></i>
            <span class="text-xl font-bold tracking-tight text-stone-800">Remini-Garden</span>
        </div>
        <div class="text-sm font-medium text-stone-500">Interactive Prototype</div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-12">
        
        <div class="grid lg:grid-cols-3 gap-8 h-[600px]">
            
            <div class="bg-stone-900 rounded-2xl p-6 flex flex-col shadow-2xl overflow-hidden">
                <h2 class="text-stone-400 text-xs font-bold uppercase tracking-widest mb-6">Simulation Controller</h2>
                
                <div class="space-y-6 overflow-y-auto pr-2 custom-scroll flex-1">
                    
                    <div>
                        <h3 class="text-green-400 font-bold text-sm mb-3 flex items-center">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Phase 1: ë°°ê²½ êµ¬ì¶•
                        </h3>
                        <div class="space-y-2">
                            <button onclick="runStep(1)" id="btn-1" class="step-btn bg-stone-800 p-3 rounded text-stone-300 text-xs">
                                <span class="block font-bold text-white mb-1">1. "ì–´ë–¤ ì§‘ì— ì‚¬ì…¨ë‚˜ìš”?"</span>
                                "ë§ˆë‹¹ ë„“ì€ ê¸°ì™€ì§‘ì´ì—ˆì§€." (ê¸°ë³¸ ë°°ê²½)
                            </button>
                            <button onclick="runStep(2)" id="btn-2" class="step-btn bg-stone-800 p-3 rounded text-stone-300 text-xs">
                                <span class="block font-bold text-white mb-1">2. "ì§‘ ëª¨ì–‘ì€ ì–´ë• ë‚˜ìš”?"</span>
                                "ì°½ë¬¸ì´ë‘ êµ´ëšì´ ìˆì—ˆì–´." (ë””í…Œì¼ ì¶”ê°€)
                            </button>
                            <button onclick="runStep(3)" id="btn-3" class="step-btn bg-stone-800 p-3 rounded text-stone-300 text-xs">
                                <span class="block font-bold text-white mb-1">3. "ë˜ ê¸°ì–µë‚˜ëŠ” ê±´ìš”?"</span>
                                "í™”ë¶„, íŒŒë€ ëŒ€ë¬¸, ëª…íŒ¨ê°€ ìˆì—ˆì§€." (ì™„ì„±)
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-blue-400 font-bold text-sm mb-3 flex items-center">
                            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span> Phase 2 & 3: ë¬¸ì œ & íšŒìƒ
                        </h3>
                        <div class="space-y-2">
                            <button onclick="runStep(4)" id="btn-4" class="step-btn bg-stone-800 p-3 rounded text-stone-300 text-xs">
                                <span class="block font-bold text-white mb-1">4. ìƒí™© ì œì‹œ (í‘ë°± ì „í™˜)</span>
                                AI: "ëˆ„ë ì´ê°€ ì‚¬ê³  ì¹œ ì  ì—†ë‚˜ìš”?"<br>
                                (â— ì´ëª¨ì§€ ë“±ì¥, í‘ë°± ëª¨ë“œ)
                            </button>
                            <button onclick="runStep(5)" id="btn-5" class="step-btn bg-stone-800 p-3 rounded text-stone-300 text-xs">
                                <span class="block font-bold text-white mb-1">5. íšŒìƒ ë° í•´ê²°</span>
                                "í•­ì•„ë¦¬ì— ë¹ ì ¸ì„œ ë‚‘ë‚‘ëŒ”ì§€!"<br>
                                (â—ì œê±°, ì˜¤ë¸Œì íŠ¸ 100%, ë°°ê²½ 30% ì»¬ëŸ¬)
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-stone-800">
                    <div class="bg-black rounded-lg p-3 h-24 overflow-y-auto font-mono text-[10px] text-green-500 leading-relaxed" id="system-log">
                        > Initializing...<br>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-stone-100 rounded-2xl overflow-hidden shadow-2xl relative group">
                <canvas id="demoCanvas" class="w-full h-full object-cover"></canvas>
                
                <div class="absolute top-6 left-6">
                    <span id="location-badge" class="bg-white/90 backdrop-blur px-4 py-2 rounded-full text-sm font-bold text-stone-800 shadow-md border border-white/50">
                        ğŸ  ë¹ˆ ê³µê°„ (Empty)
                    </span>
                </div>

                <div class="absolute top-6 right-6">
                    <div class="bg-black/70 backdrop-blur px-3 py-1.5 rounded-full text-xs font-bold text-white shadow-sm flex items-center gap-2">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-stone-500"></div>
                        <span id="status-text">Standby</span>
                    </div>
                </div>

                <div id="nav-controls" class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-6 opacity-0 transition-opacity duration-500 pointer-events-none">
                    <button onclick="changeScene(-1)" class="nav-arrow w-12 h-12 rounded-full flex items-center justify-center text-white pointer-events-auto">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <span class="text-white text-xs font-bold bg-black/40 px-4 py-2 rounded-full backdrop-blur pointer-events-auto border border-white/20">
                        ê³µê°„ ì´ë™
                    </span>
                    <button onclick="changeScene(1)" class="nav-arrow w-12 h-12 rounded-full flex items-center justify-center text-white pointer-events-auto">
                        <i data-lucide="arrow-right" class="w-6 h-6"></i>
                    </button>
                </div>

                <div id="loader" class="absolute inset-0 bg-black/40 backdrop-blur-sm flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
                    <div class="spinner mb-3"></div>
                    <span class="text-white text-xs font-bold tracking-wider" id="loader-text">GENERATING...</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof lucide!== 'undefined') lucide.createIcons();
            preloadAll();
        });

        // ---------------------------------------------------------
        // 1. Data & Assets
        // ---------------------------------------------------------
        const assetsConfig = {
            bg1: "https://i.ibb.co/qMRZ7QY4/bg-1.png",
            bg2: "https://i.ibb.co/q3ZwXFN2/bg-2.png",
            bg3: "https://i.ibb.co/twsTF5PJ/bg-3.png", 
            jar: "https://i.ibb.co/0jNBM0fQ/hangari.png",
            dog: "https://i.ibb.co/CK0X3QmQ/dog.png"
        };

        const scenes = [ { id: 'yard', name: 'ë§ˆë‹¹' }, { id: 'anbang', name: 'ì•ˆë°©' }, { id: 'kitchen', name: 'ë¶€ì—Œ' } ];
        const images = {}; 
        let isReady = false;

        function preloadAll() {
            const log = document.getElementById('system-log');
            const urls = Object.values(assetsConfig);
            let loadedCount = 0;
            urls.forEach(url => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = url;
                img.onload = () => {
                    loadedCount++;
                    if(loadedCount === urls.length) {
                        isReady = true;
                        log.innerHTML += `<br>> All assets loaded. Ready.`;
                    }
                };
                images[url] = img;
            });
        }

        // ---------------------------------------------------------
        // 2. Application State
        // ---------------------------------------------------------
        const state = {
            sceneIndex: 0,
            bgLevel: 0,      
            hasObjects: false,
            objProgress: 0, // 0 to 1 for Pop-up animation
            
            // Fading & Color State
            bgOpacity: 0,       
            targetBgOpacity: 0, 
            
            bgGrayscale: 0,     // Background Grayscale %
            objGrayscale: 0,    // Object Grayscale %
            
            showEmoji: false,   
            emojiOpacity: 0
        };

        // ---------------------------------------------------------
        // 3. Rendering Engine
        // ---------------------------------------------------------
        const canvas = document.getElementById('demoCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            if (canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
        }
        window.addEventListener('resize', resize);
        resize();

        // Pop-up Easing: BackOut
        const easeOutBack = (x) => {
            const c1 = 1.70158; const c3 = c1 + 1;
            return 1 + c3 * Math.pow(x - 1, 3) + c1 * Math.pow(x - 1, 2);
        };

        function draw() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            if (!isReady) {
                ctx.fillStyle = "#e5e7eb"; ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = "#374151"; ctx.textAlign = "center"; ctx.fillText("Loading Assets...", w/2, h/2);
                requestAnimationFrame(draw);
                return;
            }

            // --- 1. Draw Background Layer ---
            ctx.save();
            
            // Handle BG Opacity Fade
            if (Math.abs(state.bgOpacity - state.targetBgOpacity) > 0.01) {
                state.bgOpacity += (state.targetBgOpacity - state.bgOpacity) * 0.1;
            } else {
                state.bgOpacity = state.targetBgOpacity;
            }
            
            ctx.globalAlpha = state.bgOpacity;
            ctx.filter = `grayscale(${state.bgGrayscale}%)`; // Background filter

            const currentScene = scenes[state.sceneIndex];
            let targetUrl = null;

            if (currentScene.id === 'yard') {
                if (state.bgLevel === 1) targetUrl = assetsConfig.bg1;
                else if (state.bgLevel === 2) targetUrl = assetsConfig.bg2;
                else if (state.bgLevel === 3) targetUrl = assetsConfig.bg3;
            } else {
                targetUrl = null; 
            }

            if (targetUrl && images[targetUrl]) {
                drawImageCover(ctx, images[targetUrl], w, h);
            } else {
                ctx.fillStyle = "#f5f5f4"; ctx.fillRect(0,0,w,h); 
                ctx.fillStyle = "#d6d3d1"; ctx.fillRect(0, h*0.6, w, h*0.4);
            }
            ctx.restore();


            // --- 2. Draw Objects Layer (Pop-up Book Style) ---
            if (currentScene.id === 'yard' && state.hasObjects) {
                ctx.save();
                ctx.filter = `grayscale(${state.objGrayscale}%)`; // Object filter separate from BG

                const scale = easeOutBack(Math.min(state.objProgress, 1));
                
                // Position: Left side of Yard (Empty space)
                // Jar (Hangari)
                if (images[assetsConfig.jar]) {
                    drawObject(ctx, images[assetsConfig.jar], 0.28, 0.85, 0.18, scale, w, h);
                }
                
                // Dog (Nu-rung-i)
                if (images[assetsConfig.dog]) {
                    drawObject(ctx, images[assetsConfig.dog], 0.38, 0.88, 0.14, scale, w, h);
                }
                ctx.restore();

                // --- 3. Draw Emoji Layer (Floating) ---
                if (state.showEmoji || state.emojiOpacity > 0.01) {
                    if(!state.showEmoji) state.emojiOpacity *= 0.9; 
                    else if(state.emojiOpacity < 1) state.emojiOpacity += 0.1;

                    if(state.emojiOpacity > 0) {
                        ctx.save();
                        ctx.globalAlpha = state.emojiOpacity;
                        ctx.font = "bold 40px serif";
                        ctx.textAlign = "center";
                        const floatY = Math.sin(Date.now() / 200) * 5; 
                        ctx.fillText("â—", w * 0.35, h * 0.65 + floatY); 
                        ctx.restore();
                    }
                }
            }

            requestAnimationFrame(draw);
        }

        // Helper: Background Cover
        function drawImageCover(ctx, img, cw, ch) {
            const imgRatio = img.width / img.height;
            const canvasRatio = cw / ch;
            let dw, dh, dx, dy;
            if (canvasRatio > imgRatio) {
                dw = cw; dh = cw / imgRatio; dx = 0; dy = (ch - dh) / 2;
            } else {
                dh = ch; dw = ch * imgRatio; dy = 0; dx = (cw - dw) / 2;
            }
            ctx.drawImage(img, dx, dy, dw, dh);
        }

        // Helper: Pop-up Object
        function drawObject(ctx, img, rx, ry, rw, scale, cw, ch) {
            const ar = img.width / img.height;
            const w = cw * rw;
            const h = w / ar;
            const x = cw * rx - w/2;
            const y = ch * ry - h;

            ctx.save();
            ctx.translate(x + w/2, y + h); 
            ctx.scale(1, Math.max(0, scale)); 
            ctx.translate(-(x + w/2), -(y + h)); 

            // Shadow
            ctx.beginPath();
            ctx.ellipse(x + w/2, y + h - 5, w/2.5, w/10, 0, 0, Math.PI*2);
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fill();

            ctx.drawImage(img, x, y, w, h);
            ctx.restore();
        }

        requestAnimationFrame(draw);


        // ---------------------------------------------------------
        // 4. Controller Logic
        // ---------------------------------------------------------
        const logEl = document.getElementById('system-log');
        const badge = document.getElementById('location-badge');
        const statusDot = document.getElementById('status-dot');
        const statusTxt = document.getElementById('status-text');

        function log(msg, type="info") {
            const color = type === "user"? "text-white" : "text-green-500";
            logEl.innerHTML += `<br>> <span class="${color}">${msg}</span>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStatus(text, colorClass="bg-green-500") {
            statusTxt.innerText = text;
            statusDot.className = `w-2 h-2 rounded-full ${colorClass}`;
        }

        function triggerFade() {
            state.targetBgOpacity = 0; // Fade out
            setTimeout(() => { state.targetBgOpacity = 1; }, 600); // Fade in
        }

        window.runStep = function(stepId) {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${stepId}`).classList.add('active');

            if (stepId === 1) {
                log(" \"ë§ˆë‹¹ ë„“ì€ ê¸°ì™€ì§‘ì´ì—ˆì§€.\"", "user");
                triggerFade();
                setTimeout(() => {
                    state.bgLevel = 1; 
                    badge.innerText = "ğŸ  ê¸°ë³¸ ë§ˆë‹¹ (Lv.1)";
                    setStatus("Building", "bg-yellow-500 animate-pulse");
                }, 500);

            } else if (stepId === 2) {
                if(state.bgLevel < 1) return alert("1ë‹¨ê³„ë¶€í„° ì§„í–‰í•´ì£¼ì„¸ìš”.");
                log(" \"ì°½ë¬¸ì´ë‘ êµ´ëšì´ ìˆì—ˆì§€.\"", "user");
                triggerFade();
                setTimeout(() => {
                    state.bgLevel = 2;
                    badge.innerText = "ğŸ  ë§ˆë‹¹ (Lv.2)";
                }, 500);

            } else if (stepId === 3) {
                if(state.bgLevel < 2) return alert("2ë‹¨ê³„ë¶€í„° ì§„í–‰í•´ì£¼ì„¸ìš”.");
                log(" \"í™”ë¶„, íŒŒë€ ëŒ€ë¬¸ì´ ìˆì—ˆì–´.\"", "user");
                triggerFade();
                setTimeout(() => {
                    state.bgLevel = 3;
                    badge.innerText = "ğŸ  ì™„ì„±ëœ ë§ˆë‹¹";
                    setStatus("Active", "bg-green-500");
                    document.getElementById('nav-controls').style.opacity = 1;
                    document.getElementById('nav-controls').style.pointerEvents = 'auto';
                }, 500);

            } else if (stepId === 4) {
                // Step 4: Crisis / Question (Turn BW)
                if(state.bgLevel < 3) return alert("3ë‹¨ê³„ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.");
                if(state.sceneIndex !== 0) changeScene(0 - state.sceneIndex);

                log("[AI] ëˆ„ë ì´ê°€ ì‚¬ê³ ì¹œ ì ì€ ì—†ì—ˆë‚˜ìš”?");
                
                const grayInt = setInterval(() => {
                    state.bgGrayscale += 5;
                    if(state.bgGrayscale >= 100) { 
                        state.bgGrayscale = 100; 
                        state.objGrayscale = 100;
                        clearInterval(grayInt); 
                        
                        state.hasObjects = true;
                        state.showEmoji = true;
                        
                        // Pop-up Animation
                        let p = 0;
                        const popInt = setInterval(() => {
                            p += 0.05; state.objProgress = p;
                            if(p >= 1) clearInterval(popInt);
                        }, 16);
                        
                        setStatus("Recalling...", "bg-purple-500");
                    }
                }, 20);

            } else if (stepId === 5) {
                // Step 5: Resolution / Color Restore
                if(!state.hasObjects) return alert("4ë‹¨ê³„ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.");
                
                log(" \"í•­ì•„ë¦¬ ìŒì‹ì„ í›”ì³ë¨¹ë‹¤ ë¹ ì¡Œì§€!\"", "user");
                
                // 1. Remove Emoji
                state.showEmoji = false;

                setTimeout(() => {
                    // 2. Restore Colors
                    const colorInt = setInterval(() => {
                        // Background: Restore only 1/3 (Stay at ~67% Grayscale)
                        if(state.bgGrayscale > 67) state.bgGrayscale -= 1; 
                        
                        // Objects: Restore Fully (0% Grayscale)
                        state.objGrayscale -= 3;
                        
                        if(state.objGrayscale <= 0) {
                            state.objGrayscale = 0;
                            // Ensure BG stops at the right place even if timing was off
                            if(state.bgGrayscale < 67) state.bgGrayscale = 67; 
                            
                            clearInterval(colorInt);
                            
                            log("[AI] íšŒìƒ ì„±ê³µ! ê¸°ì–µì˜ ì¡°ê°ì´ ë§ì¶°ì¡ŒìŠµë‹ˆë‹¤.", "text-yellow-400");
                            setStatus("Memory Restored", "bg-blue-500");
                        }
                    }, 20);
                }, 500);
            }
        };

        window.changeScene = function(dir) {
            if (state.bgLevel < 3) return;
            triggerFade();
            setTimeout(() => {
                state.sceneIndex += dir;
                if (state.sceneIndex < 0) state.sceneIndex = scenes.length - 1;
                if (state.sceneIndex >= scenes.length) state.sceneIndex = 0;
                badge.innerText = `ğŸ  ${scenes[state.sceneIndex].name}`;
            }, 500);
        }

    </script>
</body>
</html>
